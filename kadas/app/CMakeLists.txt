SET(CMAKE_AUTOMOC ON)

FIND_PACKAGE(PythonLibs 3.0 REQUIRED)

OPTION(WITH_GLOBE "Enable globe" ON)
IF(WITH_GLOBE)
    FIND_PACKAGE(OSG REQUIRED)
    FIND_PACKAGE(OSGEARTH REQUIRED)
    ADD_DEFINITIONS(-DWITH_GLOBE)
    INCLUDE_DIRECTORIES(${OSGEARTH_INCLUDE_DIR})
    INCLUDE_DIRECTORIES(${OSG_INCLUDE_DIR})

    SET(GLOBE_LIBS 
    ${OSGDB_LIBRARY}
    ${OSGGA_LIBRARY}
    ${OSGUTIL_LIBRARY}
    ${OSG_LIBRARY}
    ${OSGQT_LIBRARY}
    ${OSGVIEWER_LIBRARY}
    ${OSGEARTH_LIBRARY}
    ${OSGEARTHANNOTATION_LIBRARY}
    ${OSGEARTHFEATURES_LIBRARY}
    ${OSGEARTHUTIL_LIBRARY}
    ${OSGEARTHSYMBOLOGY_LIBRARY}
    ${OSGEARTHQT_LIBRARY}
    ${OPENTHREADS_LIBRARY}
    )
ENDIF(WITH_GLOBE)

FILE(GLOB kadas_SRC
  *.cpp
  milx/*.cpp
  kml/*.cpp
  bullseye/*.cpp
  guidegrid/*.cpp
  mapgrid/*.cpp)
IF(WITH_GLOBE)
    FILE(GLOB globe_SRC globe/*.cpp)
    SET(kadas_SRC ${kadas_SRC} ${globe_SRC})
ENDIF(WITH_GLOBE)
LIST(SORT kadas_SRC)

FILE(GLOB kadas_HDR
  *.h
  milx/*.h
  kml/*.h
  bullseye/*.h
  guidegrid/*.h
  mapgrid/*.h)
IF(WITH_GLOBE)
    FILE(GLOB globe_HDR globe/*.h)
    SET(kadas_HDR ${kadas_HDR} ${globe_HDR})
ENDIF(WITH_GLOBE)
LIST(SORT kadas_HDR)

FILE(GLOB kadas_UI
  ui/*.ui
  kml/*.ui
  bullseye/*.ui
  guidegrid/*.ui
  mapgrid/*.ui)
IF(WITH_GLOBE)
    FILE(GLOB globe_UI globe/*.ui)
    SET(kadas_UI ${kadas_UI} ${globe_UI})
ENDIF(WITH_GLOBE)
LIST(SORT kadas_UI)

SET(kadas_RCC_SRC ../resources/resources.qrc)

QT5_ADD_RESOURCES(kadas_RCC ${kadas_RCC_SRC})
QT5_WRAP_UI(kadas_UI_HDR ${kadas_UI})

IF(MINGW)
  ENABLE_LANGUAGE(RC)
  SET(CMAKE_RC_COMPILER_INIT ${CMAKE_GENERATOR_RC})
  SET(CMAKE_RC_COMPILE_OBJECT "<CMAKE_RC_COMPILER> -O coff -i <SOURCE> -o <OBJECT>")
  SET(kadas_SRC ${kadas_SRC} ../resources/kadas-icon.rc)
  SET(kadas_RC_LIBS -mwindows)
ENDIF(MINGW)

SET_PROPERTY(SOURCE ${kadas_UI_HDR} PROPERTY SKIP_AUTOMOC ON)
SET_PROPERTY(SOURCE ${kadas_RCC} PROPERTY SKIP_AUTOMOC ON)

INCLUDE_DIRECTORIES(${CMAKE_CURRENT_BINARY_DIR})
INCLUDE_DIRECTORIES(${QCA_INCLUDE_DIRS})
INCLUDE_DIRECTORIES(${QTKEYCHAIN_INCLUDE_DIRS}/qt5keychain)
INCLUDE_DIRECTORIES(${PYTHON_INCLUDE_DIR})
INCLUDE_DIRECTORIES(${CAIRO_INCLUDE_DIRS})
INCLUDE_DIRECTORIES(${LIBRSVG_INCLUDE_DIRS})
INCLUDE_DIRECTORIES(${GEOS_INCLUDE_DIR})

ADD_EXECUTABLE(kadas
    ${kadas_SRC}
    ${kadas_HDR}
    ${kadas_UI}
    ${kadas_UI_HDR}
    ${kadas_RCC_SRC}
    ${kadas_RCC}
)

TARGET_LINK_LIBRARIES(kadas
  Qt5::Widgets
  Qt5::Network
  Qt5::Xml
  Qt5::Sql
  Qt5::OpenGL
  Qt5::PrintSupport
  ${QGIS_CORE_LIBRARY}
  ${QGIS_GUI_LIBRARY}
  ${CRASHRPT_LIBRARY}
  ${QCA_LDFLAGS}
  ${QTKEYCHAIN_LIBRARIES}
  ${QUAZIP_LIBRARIES}
  ${PYTHON_LIBRARIES}
  ${CAIRO_LIBRARIES}
  ${LIBRSVG_LIBRARIES}
  ${kadas_RC_LIBS}
  ${GLOBE_LIBS}

  kadas_core
  kadas_analysis
  kadas_gui
)

FILE(WRITE ${CMAKE_RUNTIME_OUTPUT_DIRECTORY}/kadassourcedir.txt ${PROJECT_SOURCE_DIR})

IF(WITH_GLOBE)
ADD_SUBDIRECTORY(globe/featuresource)
ENDIF(WITH_GLOBE)

INSTALL(TARGETS kadas DESTINATION bin)
